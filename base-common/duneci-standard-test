#! /bin/bash

set -e
set -u

: ${DUNECI_OPTS:=/duneci/opts.gcc}
set -- --opts="${DUNECI_OPTS}" "${@}"

DUNECONTROL=dunecontrol
if [[ -x bin/dunecontrol ]]; then
  DUNECONTROL=bin/dunecontrol
fi

DUNE_CTEST=duneci-ctest
if [[ -x bin/dune-ctest ]]; then
  DUNE_CTEST=../bin/dune-ctest
fi

parallel_opts=
if [[ -v DUNECI_PARALLEL ]]; then
  parallel_opts="-j${DUNECI_PARALLEL}"
fi

set -x
${DUNECONTROL} --current "${@}" vcsetup
${DUNECONTROL} --current "${@}" configure
${DUNECONTROL} --current "${@}" make ${parallel_opts} all build_tests
${DUNECONTROL} --current "${@}" bexec ${DUNE_CTEST} ${parallel_opts}
