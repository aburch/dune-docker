#! /bin/bash

set -e
set -u

if [[ -n "${DUNECI_OPTS:-/duneci/opts.gcc}" ]]; then
  set -- --opts="${DUNECI_OPTS}" "${@}"
fi

DUNECONTROL=dunecontrol
if [[ -x bin/dunecontrol ]]; then
  DUNECONTROL=bin/dunecontrol
fi

DUNE_CTEST=duneci-ctest
if [[ -x bin/dune-ctest ]]; then
  DUNE_CTEST=../bin/dune-ctest
fi

set -x
${DUNECONTROL} --current "${@}" all
${DUNECONTROL} --current make build_tests
cd build-cmake
${DUNE_CTEST}
